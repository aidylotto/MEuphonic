<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>MEuphonic</title>
    <style>
      :root { --bg:#0b0f17; --card:#121a27; --text:#e9eef7; --muted:#a8b3c7; --accent:#6aa6ff; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
      .wrap { max-width: 980px; margin: 40px auto; padding: 0 18px; }
      h1 { font-size: 34px; margin: 0 0 8px; }
      .sub { color: var(--muted); margin: 0 0 22px; }
      .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
      .card { background: var(--card); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 18px; }
      textarea { width: 97%; height: 140px; padding: 12px; font-size: 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.25); color: var(--text); box-sizing: border-box; }
      .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; margin-top: 12px; }
      .btn { border: 0; border-radius: 10px; padding: 10px 14px; background: var(--accent); color:#061225; font-weight: 650; cursor: pointer; }
      .btn.secondary { background: transparent; color: var(--text); border: 1px solid rgba(255,255,255,0.18); }
      .pill { padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.14); color: var(--muted); cursor: pointer; }
      .pill.active { border-color: var(--accent); color: var(--text); }
      .list { margin-top: 12px; display: grid; gap: 10px; }
      .item { display:flex; justify-content: space-between; gap: 10px; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.18); }
      .item .meta { display:flex; flex-direction: column; gap: 2px; }
      .name { font-weight: 700; }
      .muted { color: var(--muted); font-size: 13px; }
      a { color: var(--accent); text-decoration: none; }
      .ctrl { display:flex; align-items:center; gap:10px; padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.20); }
      select { padding:6px; border-radius:10px; background:rgba(0,0,0,0.25); color:var(--text); border:1px solid rgba(255,255,255,0.12); }
      .hint { color: var(--muted); font-size: 13px; margin-top: 8px; }
      .split { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      @media (max-width: 720px){ .split { grid-template-columns: 1fr; } }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1>MEuphonic</h1>
      <p class="sub">Mood → Music Engine (AI MIDI generation + Spotify discovery)</p>

      <div class="grid">
        <div class="card">
          <div class="row">
            <span id="modeMidi" class="pill active" onclick="setMode('midi')">AI MIDI</span>
            <span id="modeSpotify" class="pill" onclick="setMode('spotify')">Spotify</span>
          </div>

          <div class="row" style="margin-top:12px;">
            <div class="ctrl">
              <label class="muted">Language:</label>
              <select id="lang">
                <option value="en">English</option>
                <option value="fa">Persian</option>
                <option value="tr">Turkish</option>
                <option value="ar">Arabic</option>
                <option value="fr">French</option>
                <option value="es">Spanish</option>
              </select>
            </div>
          </div>

          <div style="margin-top: 12px;">
            <label class="muted">Describe your mood / feeling</label>
            <textarea id="desc" placeholder="e.g., lonely night walk in the rain after a breakup"></textarea>
            <div class="hint" id="modeHint">
              MIDI mode generates a multi-track MIDI file.
            </div>
          </div>

          <div class="row">
            <button class="btn" onclick="runPrimary()">Run</button>
            <button class="btn secondary" onclick="resetUI()">Reset</button>
          </div>

          <div id="spotifyArea" style="display:none; margin-top: 12px;">
            <div class="split">
              <div>
                <div class="muted">Artists</div>
                <div class="list" id="artistList"></div>
              </div>
              <div>
                <div class="muted">Tracks</div>
                <div class="list" id="trackList"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <script>
      let mode = "midi";
      let variant = 0;

      function setMode(m) {
        mode = m;
        document.getElementById("modeMidi").classList.toggle("active", m === "midi");
        document.getElementById("modeSpotify").classList.toggle("active", m === "spotify");
        document.getElementById("spotifyArea").style.display = (m === "spotify") ? "block" : "none";
        document.getElementById("modeHint").textContent =
          (m === "spotify")
          ? "Spotify mode: choose an artist, then get mood-matched tracks."
          : "MIDI mode generates a downloadable MIDI file.";
        resetLists();
      }

      function resetLists() {
        document.getElementById("artistList").innerHTML = "";
        document.getElementById("trackList").innerHTML = "";
      }

      function resetUI() {
        document.getElementById("desc").value = "";
        resetLists();
        variant = 0;
      }

      async function runPrimary() {
        const description = document.getElementById("desc").value.trim();
        if (!description) { alert("Please enter a description."); return; }

        if (mode === "midi") {
          await generateMidi(description);
        } else {
          await fetchArtists(description);
        }
      }

      async function generateMidi(description) {
        const form = new FormData();
        form.append("description", description);

        const res = await fetch("/generate", { method: "POST", body: form });
        if (!res.ok) {
          alert("Failed to generate MIDI.");
          return;
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "meuphonic.mid";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      async function fetchArtists(description) {
        resetLists();

        const form = new FormData();
        form.append("description", description);
        form.append("variant", variant);

        const res = await fetch("/spotify/artists", { method: "POST", body: form });
        if (!res.ok) {
          alert("Failed to fetch artists.");
          return;
        }

        const data = await res.json();
        renderArtists(data.artists || []);
      }

      function renderArtists(artists) {
        const el = document.getElementById("artistList");
        if (!artists.length) {
          el.innerHTML = `<div class="item"><div class="meta"><div class="name">No artists found</div></div></div>`;
          return;
        }

        el.innerHTML = artists.map(a => `
          <div class="item">
            <div class="meta">
              <div class="name">${escapeHtml(a.name)}</div>
              <div class="muted">Popularity: ${a.popularity}</div>
            </div>
            <button class="btn secondary" onclick="chooseArtist('${a.id}')">Choose</button>
          </div>
        `).join("");
      }

      async function chooseArtist(artistId) {
        const description = document.getElementById("desc").value.trim();

        const form = new FormData();
        form.append("description", description);
        form.append("artist_id", artistId);

        const res = await fetch("/spotify/tracks", { method: "POST", body: form });
        if (!res.ok) {
          alert("Failed to fetch tracks.");
          return;
        }

        const data = await res.json();
        renderTracks(data.tracks || []);
      }

      function renderTracks(tracks) {
        const el = document.getElementById("trackList");
        if (!tracks.length) {
          el.innerHTML = `<div class="item"><div class="meta"><div class="name">No tracks found</div></div></div>`;
          return;
        }

        el.innerHTML = tracks.map(t => `
          <div class="item">
            <div class="meta">
              <div class="name">${escapeHtml(t.name)}</div>
              <div class="muted">${escapeHtml(t.artist)} • Popularity: ${t.popularity}</div>
            </div>
            <button class="btn" onclick="window.open('${t.url}','_blank')">Play</button>
          </div>
        `).join("");
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
    </script>
  </body>
</html>
